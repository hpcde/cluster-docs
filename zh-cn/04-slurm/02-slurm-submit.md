# 申请计算资源并运行程序

用户使用集群时，主要会涉及以下操作：

- 查看信息（分区信息、节点信息、作业信息）
- 提交作业
- 取消作业
- 挂起/恢复作业
- 调整作业的属性
- 传输文件

本节会逐个介绍这些操作。

## 如何提交作业

提交作业的命令主要是：

- `salloc`，申请计算资源，随后可以登陆并使用计算资源；
- `srun`，申请计算资源并实时运行程序，会阻塞终端；
- `sbatch`，申请计算资源并随后运行程序，不会阻塞终端。

> 注：`sbatch`通常配合提交作业的脚本来使用，但它也可以直接在命令行使用。同样，`srun`常常会直接在命令行中被使用，但它也可以写在脚本里提交给`sbatch`。

这三个命令的命令行选项基本一样，具体的选项参考手册：

```
$ man salloc
$ man srun
$ man sbatch
```

接下来我们对一些常用的选项作一点注释，方便大家理解。如果有不明白的地方，请：

- 参考系统上的手册或[官网](https://slurm.schedmd.com/)的说明，官网上的使用说明非常全面（推荐）；
- Google相关用法；
- Google或百度其他集群的手册。

列表中的尖括号内是用户给的参数。

| 参数                                          | 含义                                                         |
| --------------------------------------------- | ------------------------------------------------------------ |
| **-p**, **--partition**=<*partition_names*>   | 指定分区。                                                   |
| **-N**, **--nodes**=<*minnodes*[-*maxnodes*]> | 请求特定的节点数量。<br />给两个参数就是请求一定范围内的节点。 |
| **-n**, **--ntasks**=<*number*>               | 指定要执行的任务（进程）数量，请求分配相应的资源。<br />默认是一个节点执行一个任务。 |
| **--ntasks-per-node**=<*ntasks*>              | 请求在每个节点上执行*ntasks*个任务。**[1]**                  |
| **-c**, **--cpus-per-task**=<*ncpus*>         | 请求给每个任务分配*ncpus*个CPU。**[2]**<br />不加这个选项，控制器会试着为每个任务分配一个CPU。 |
| **-o**, **--output**=<*filename pattern*>     | 指明将stdout重定向到某个文件，即打印标准输出。<br />如果不指定**--error**，则错误信息也输出到这个文件里。 |
| **-e**, **--error**=<*filename pattern*>      | 指明将stderr重定向到某个文件，即打印错误信息。               |
| **-t**, **--time**=<*time*>                   | 为作业指定时间限制。格式为<br />"minutes", "minutes:seconds", <br />"hours:minutes:seconds", "days-hours", <br />"days-hours:minutes", "days-hours:minutes:seconds" |
| **-J**, **--job-name**=<*jobname*>            | 指定作业的名称。可选项，便于用户识别自己提交的作业。                                             |
| **-w**, **--nodelist**=<*hosts*>              | 指定运行程序的节点，语法见手册。                             |
| **-F**, **--nodefile**=<*node file*>          | 指定运行程序的节点                                           |
| **-x**, **--exclude**=<*hosts*>               | 排除一些节点，语法见手册。                                   |
| **-D**, **--chdir**=<*path*>                  | 执行进程前，先切换到另一个路径*path*。<br />默认路径为用户执行SLURM命令的当前路径。<br />可以使用绝对路径或者相对于当前路径的路径。 |
| **--mincpus**=<*n*>                           | 要求每节点至少有这么多个逻辑CPU。                            |
| **--comment**=<*string*>                      | 给作业加个注释。<br />注释中有空格或特殊字符时，要加引号。   |
| **--deadline**=<*OPT*>                        | 给作业设定期限，到期还未结束就移除这个作业。格式为<br />HH:MM[:SS] [AM\|PM]<br />MMDD[YY] or MM/DD[/YY] or MM.DD[.YY]<br />MM/DD[/YY]-HH:MM[:SS]<br />YYYY-MM-DD[THH:MM[:SS]]] |

> **[1]**：`--ntasks`优先于`--ntasks-per-node`，如果两个一起用，则`--ntasks-per-node`会被当成单节点任务数量的上限。
>
> **[2]**：`-c`一般与`-n`配合使用，否则，SLURM会尽量把进程塞满节点。假设节点有8个CPU，`-N 4 -c 3`意味着请求4个节点，每个节点1个进程（默认），每个进程3个CPU。但SLURM可能只分配2个节点，每个节点2个进程，每个进程3个CPU。
>
> 更多实例请见本文档的后续章节。

## 提交交互式作业 - salloc

用户可以先申请计算资源，再使用 SSH 登陆到分配给自己的节点上完成操作。这种模式便于用户调试程序，但要注意资源使用的时限，超过时限会自动断开连接。

目前，绝大多数能在 *node01* 上完成的工作都能在远程节点上完成。因此，如果你想编译程序、调试程序，我们推荐你使用 `salloc` 申请一个或多个节点，再 SSH 到这些节点上完成工作。

### 基本用法

当用户申请了节点并使用 SSH 登陆到节点上时，SLURM 会给用户分配一个 shell，因此，当用户退出时，需要使用两次`exit`。下面我们在`Balerion`分区申请1个节点，并登陆到这个节点上。

```
$ salloc -N 1 -c 12 -t 30:00 -p Balerion
salloc: Granted job allocation 95
salloc: Waiting for resource configuration
salloc: Nodes node21 are ready for job
```

上述命令指定了分区`-p Balerion`，节点数量`-N 1`，CPU数量`-c 12`，资源使用的时限`-t 30:00`。申请成功后，用户会进入由 SLURM 创建的 shell。

随后，使用 SSH 登陆到节点`node01`并执行操作。

```
$ ssh node21
```

> 注：目前全节点共享的存储空间只有`/home`和`/data`。用户在登陆到计算节点后，若发现`/home`的空间已经不够用，请切换到`/data/user`目录下，`user`是你的用户名。若要使用计算节点的本地存储，可以用`/tmp`。

完成操作后，如果不再使用这个节点的计算资源，则退出。

```
$ exit
logout
Connection to node21 closed.
$ exit
exit
salloc: Relinquishing job allocation 95
```

此时，节点`node21`已经可以重新分配给其他作业了。

使用 `--exclusive` 参数，可以独占节点而不用指定任务数量、CPU 数量。

```bash
$ salloc -N1 --exclusive -t 30:00 -p Balerion
```

### 与 `screen` 配合使用

使用 `screen` 可以创建在后台运行的 SSH 会话，类似于 `&`。最常见的是在登陆节点上使用它来保存自己的 SSH 会话，以便下次连接到登陆节点时能恢复。

```bash
$ screen -S mysession       # 创建一个会话
$ screen -ls                # 查看所有会话
$ screen -r                 # 恢复会话
```

> 注：`-r` 选项不带任何参数时，会恢复仅有的会话。如果会话数量不止一个，则需要以会话名作为参数。

`screen` 工具的具体用法可参考其手册。

这个工具同样可以保存 `salloc` 申请资源后由 SLURM 分配的 SHELL。我们只要在一个创建好的会话里面申请资源即可。

```bash
$ screen -S myalloc                     # 创建会话
$ salloc -N1 --exclusive -p Vhagar      # 申请资源
```

执行以上两行命令后，即使网络中断，也可以通过命令恢复之前的会话。

```bash
$ screen -r myalloc
```

## 提交批处理作业 - srun | sbatch

批处理作业指的是用户直接提交给集群的作业。作业完成后，用户会得到输出结果。在作业执行期间，用户可以使用 SSH 登陆到分配给自己的节点上。

提交作业一般有两个命令：`srun`和`sbatch`。

### srun

该命令用于提交作业并实时运行。它是个交互式命令，并且会阻塞你的终端。它的参数与`salloc`类似，具体用法请参考官方文档或查看手册：

```
$ man srun
```

下面我们申请一个节点（可以指定节点），开两个进程，每个进程都执行相同的命令：

```
$ srun -N 1 -n 2 hostname
node05
node05

$ srun -w node06 -n 2 hostname
node06
node06

$ srun -N 2 hostname
node05
node06
```

可以发现，在这三条命令中，`hostname` 都执行了两次。换句话说，申请的资源数量就是使用的资源数量。这是 `srun` 最基本的用法：申请资源，并完全使用这些资源。

在后续章节中，我们会看到另一种用法，即申请资源后只使用申请的一部分资源。

### sbatch

该命令用于提交作业（包括分配资源）。它不是交互式的，也不会阻塞终端。如果作业运行时间较长，建议用这个命令。它的参数与`srun`一样。接下来我们重点介绍一下它的使用方法，这部分的很多内容都是适用于 `salloc` 和 `srun` 的。

#### 基本命令格式

```bash
sbatch [options] script [args]
```

使用 `sbatch` 时，要指明申请的资源数量，如节点数、任务数、CPU数等；还要指明待执行的脚本名称。随后，SLURM 会分配相应的资源（或挂起作业），并将用户的脚本拷贝到计算节点上执行。其中，脚本名必须提供给 sbatch。

例如，我们想跑一个程序（记为 `myprog`）。我们会希望在跑之前先编译，跑完后输出结果并且清理一下编译过程中产生的文件。这个工作可以全部写在脚本中提交。假设脚本为 `mybatch`。

```bash
$ vim mybatch
    #!/bin/sh
    #SBATCH -J compile-and-run
    #SBATCH -o %x-%j.log
    #SBATCH -p Vhagar
    #SBATCH -n 1

    ml GCC                  ## 加载所需的编译器
    gcc myprog.c -o myprog  ## 编译
    srun myprog             ## 执行
    rm myprog               ## 清理文件

$ sbatch mybatch
```

上述脚本分为两大部分，第一部分是以 `#SBATCH` 开头的资源申请部分，其解释如下：

- `-J myjob` 指定作业的名称，便于用户从多个已经提交的作业中识别它。不指定名称的话，系统会自动分配一个。
- `-o %x-%j.log` 指定作业的输出位置。`%x` 和 `%j` 是替换符，分别表示作业名和作业编号。关于替换符的说明，请参考手册 `man sbatch`。
- `-p Vhagar` 指定分区。使用前请通过 `sinfo`、`snodes` 等命令确认哪个分区有空闲节点，否则作业可能要排队等待。
- `-n 1` 指定任务数量。在这里我们只要求执行1个进程。

第二部分是执行部分，也就是作业步。如果分配了多个节点，被提交的脚本 `mybatch` 会交由第一个节点执行。这些作业步大致有三类命令：

- 加载环境变量：环境变量会从第一个节点广播到其他所有计算节点。例如 `ml GCC`，加载之后，每个计算节点都能使用 `GCC` 的同一版本。
- 不带 `srun` 的命令：会在第一个节点上执行。因此 `gcc ...` 这句编译命令和 `rm ...` 这句清理命令，都只在第一个节点上执行。
- 带 `srun` 的命令：会在所有节点上执行，是并行任务。因此 `srun myprog` 这句会在所有申请到的计算节点上执行。

执行完毕后，计算节点的输出（包括 `stdout` 和 `stderr`）都可以在输出文件中看到。默认的输出文件名称为 `slurm-作业名.out `，这里的例子中使用 `-o` 参数指定了一个输出文件名称。

#### 命令行选项和参数

由脚本中 `#SBATCH` 指定的选项和由命令行直接输入的选项是一样的。例如，以下脚本和命令可以达到和前例相同的效果。

```bash
$ vim mybatch
    #!/bin/sh
    #SBATCH -J compile-and-run
    #SBATCH -o %x-%j.log

    ml GCC                  ## 加载所需的编译器
    gcc myprog.c -o myprog  ## 编译
    srun myprog             ## 执行
    rm myprog               ## 清理文件

$ sbatch -p Vhagar -n 1 mybatch
```

#### 作业的时限

执行时间较长的作业需要手动指定时间限制，因为默认的时间限制可能不满足要求。选项 `-t` 的格式我们在前面总结过了。例如，我们可以指定时间为数分钟甚至数天。

```bash
## 时限为30分钟
#SBATCH -t 30:00

## 时限为12小时
#SBATCH -t 12:00:00

## 时限为2天零12小时
#SBATCH -t 2-12:00:00
```

如果需要给作业设置一个期限，让作业到期就被终止，可以用 `--deadline`。这个选项可以在作业提交之后通过 `scontrol` 附加上去。

某些情况下，我们可能希望自己的作业在特定时间执行，或者在数小时之后执行。比如定期跑一个清理脚本，跑一个数据分析软件或者脚本之类的。此时可以用 `--begin` 选项来完成。

```bash
## 当天晚上9点开始
#SBATCH --begin=21:00:00

## 6小时以后开始
#SBATCH --begin=now+6hour

## 2100年1月1日凌晨开始
#SBATCH --begin=2100-01-01T00:00:00
```

#### 作业的依赖关系

一个作业可以设置与其他作业的依赖关系。考虑以下场景：

我们有不同版本的代码需要编译（使用不同编译器），这些编译后的程序我们要同时提交运行。一种解决方案是，分为2个脚本完成：脚本 A 负责一个接一个地编译，这样能避免多个编译过程产生相同的中间文件（如 `*.o` 文件）相互覆盖；脚本 B 负责把编译后的程序提交给集群去执行。

`mybatchA` 中的选项没什么特别的。提交之后可以看到它的作业编号 `JobID`，假设是 103。接下来，`mybatchB`中要加上一个选项：

```bash
#SBATCH -d afterok:103
```

这一句指明了，`mybatchB` 会在 `mybatchA` 成功执行时才会执行。除此之外，还有其他的依赖，例如：

```bash
## 在作业 103 开始执行之后
#SBATCH -d after:103

## 在作业 103 和 104 都失败之后，失败的原因有很多
#SBATCH -d afternotok:103 104

## 单例作业，在所有同名、同用户的作业都结束后才执行
#SBATCH -d singleton
```

在提交作业时，多个作业的作业名是可以重复的，因此`singleton` 有时会很有用的，它保证当前任务执行时没有和它作业名、用户名相同的任务。

在手册中可以看到 `-d` 选项的所有参数。

## 取消作业 - scancel

该命令用于取消已提交的作业。可以通过参数指定作业、筛选条件等。

```
$ scancel 103
```

## 更新作业相关信息 - scontrol update job

该命令用于更新一个已提交的作业的信息。如果作业提交后发现时间写短了，或者想附加一些参数，用户应该使用这个命令更新，而不是取消作业再重新提交。

命令的格式可以为：

```bash
scontrol update job=JobID [Attr1=Value1] [Att2=Value2] ...
```

其中，`JobID` 是要更新的作业编号，`Attr` 和 `Value` 分别是待更新的作业属性和值。例如，我们要更新编号为 `103` 的作业，把它的时限调整为 `7` 天整。

```bash
$ scontrol update job=103 TimeLimit=7-00
```

> 注：`job=103` 可以写成 `job 103`。属性名称`TimeLimit` 不区分大小写，可以写成 `timelimit`。

属性的名字可以通过以下命令查看：
```bash
$ scontrol show job 103
```

## 发送文件 - sbcast

该命令用于发送文件到计算节点上。使用这个命令之前，请仔细阅读手册。如果在脚本中把文件发送到计算节点上，请同时清理这些文件。

一般情况下，尽量使用共享存储空间`/home`和`/data`，而非`sbcast`命令。
