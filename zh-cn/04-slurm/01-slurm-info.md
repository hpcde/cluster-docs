# 使用计算资源 - SLURM

用户可以提交作业到集群，由 SLURM 分配计算资源。目前，在实验室集群，任何人都可以提交以下作业：

- OpenMP 程序；
- MPI 程序。
- MPI/OpenMP 混合程序。

用户可以直接提交一个作业，待执行完成后查看返回结果；也可以申请计算资源，登陆到相应的节点上完成操作。在得到计算资源后（比如作业运行期间），用户可以使用 SSH 登陆到分配给自己的节点上。在提交作业之间，请检查现有的空闲计算资源。

需要使用大量计算资源或内存的程序都请提交给 SLURM 运行，不要在本地运行。例如：

- 测试项目中的程序；
- 测试机器、软件、库的性能；
- 编译一些大型程序，比如编译 GCC。

> 注：编译工作也请提交到 *Vhagar* 或 *Balerion* 分区。提交的脚本中可以写编译命令、`make`等，支持 SHELL。

## 如何查看信息

SLURM 提供了一系列命令用于查看分区、节点、作业等信息。以下给出简单的用法。

### 查看分区信息 - sinfo

该命令用于查看当前集群的所有分区信息，包括分区和节点的状态。

```
$ sinfo
PARTITION AVAIL TIMELIMIT NODES STATE NODELIST
Balerion	 up	  1:00:00	  4	down* node[17-20]
Balerion	 up	  1:00:00	  3	 idle node[21-23]
Vhagar*		 up	  3:00:00	  2	alloc node[05-06]
Vhagar*		 up	  3:00:00	  6	  mix node[07-12]
```

> 注：节点和分区的信息以集群上的实时数据为准，这里只是用于演示。

`PARTITION`	指明了节点的分区，每个任务都只能提交到分区中，不能跨分区。默认分区的名称后有`*`号；

`AVAIL`		指明了分区的状态，`UP`表示分区可用；

`TIMELIMIT`	指明了分区对作业的时间限制，所有提交到该分区的作业都不能超过时间上限；

`NODES`		指明了分区中的节点数量，这是该分区所有可以分配给用户的计算节点；

`STATE`		指明了节点的状态。常见状态：`down`表示不可用，`idle`表示空闲节点，`alloc`表示已完全分配给用户使用，`mix`表示已分配给用户，但仍有剩余的计算资源可用。同一分区可能会占据多个条目，这是因为分区中节点的状态不同；

`NODELIST`	指明了节点的名称。

### 查看作业队列 - squeue

该命令用于查看当前在队列中的作业。可以通过参数筛选作业，具体参数见手册。

```
$ squeue
```

### 查看历史作业 - sacct

直接运行该命令，可以查看当前用户的历史作业。可以通过参数调整输出，具体参数见手册。

```
$ sacct
```

### 查看详细信息 - scontrol show

该命令可以查看很多信息，比如分区、节点的详细信息。示例如下。

查看所有分区信息/查看某个分区的信息：

```
$ scontrol show partition
$ scontrol show Vhagar
```

查看所有节点信息/查看某个节点的信息：

```
$ scontrol show node
$ scontrol show node node05
```

查看所有作业信息/查看某个作业的信息：

```
$ scontrol show job
$ scontrol show job 103
```

## 分区的限制

本部分可能不会频繁更新，最新信息请使用命令在集群上查看。

每个分区的时间限制、资源限制可能不同。目前来说，两个分区的限制如下：

**Vhagar** 分区

- 作业的默认时限：6小时

- 作业的最长时限：无限制

- 每个CPU默认分配的内存：1024 MiB

- 每个CPU最大可分配内存：2645 MiB

- 默认的资源使用方式：非独占

**Balerion** 分区

- 作业的默认时限：6小时

- 作业的最长时限：12小时

- 每个CPU默认分配的内存：1024 MiB

- 每个CPU最大可分配内存：1984 MiB

- 默认的资源使用方式：非独占

> 作业的默认时限指的是，一个作业在未给定时间限制时，系统默认设置的时间限制，超时的作业会被杀掉。提交作业时可以用 `-t` 来指定时间限制。
>
> **非独占**的资源使用方式指的是，节点以 CPU 为单位分配，除非用户加上参数 `--exclusive` 来占据整个节点。