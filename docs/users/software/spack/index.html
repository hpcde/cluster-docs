<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-users/software/spack">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="alternate" type="application/rss+xml" href="/cluster-docs/blog/rss.xml" title="HPCer Clusters Document RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cluster-docs/blog/atom.xml" title="HPCer Clusters Document Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="HPCer Clusters Document" href="/cluster-docs/opensearch.xml">
<script src="https://buttons.github.io/buttons.js" async defer="defer"></script><title data-rh="true">Spack - 使用集群上的软件 | HPCer Clusters Document</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://hpcdoc.pages.hpcer.dev/cluster-docs/docs/users/software/spack"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spack - 使用集群上的软件 | HPCer Clusters Document"><meta data-rh="true" name="description" content="Spack是一个为超算平台设计的包管理工具，它能较好地处理依赖关系，用法上类似于 Lmod、Anaconda。"><meta data-rh="true" property="og:description" content="Spack是一个为超算平台设计的包管理工具，它能较好地处理依赖关系，用法上类似于 Lmod、Anaconda。"><link data-rh="true" rel="icon" href="/cluster-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hpcdoc.pages.hpcer.dev/cluster-docs/docs/users/software/spack"><link data-rh="true" rel="alternate" href="https://hpcdoc.pages.hpcer.dev/cluster-docs/docs/users/software/spack" hreflang="en"><link data-rh="true" rel="alternate" href="https://hpcdoc.pages.hpcer.dev/cluster-docs/docs/users/software/spack" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/cluster-docs/assets/css/styles.ccdbfcb5.css">
<link rel="preload" href="/cluster-docs/assets/js/runtime~main.540aceb6.js" as="script">
<link rel="preload" href="/cluster-docs/assets/js/main.45e5c709.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cluster-docs/"><div class="navbar__logo"><img src="/cluster-docs/img/logo.svg" alt="HPCer Clusters Document Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/cluster-docs/img/logo.svg" alt="HPCer Clusters Document Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">HPCer Clusters Document</b></a><a class="navbar__item navbar__link navbar__link--active" href="/cluster-docs/docs/users/getting-started">User Manual</a><a class="navbar__item navbar__link" href="/cluster-docs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hpcde/cluster-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Source on Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/getting-started">首页</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/cluster-overview">集群概况</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/login/normal-login">登录到集群</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/cluster-docs/docs/users/software/spack">软件与工具</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cluster-docs/docs/users/software/spack">Spack - 使用集群上的软件</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-docs/docs/users/software/lmod">Lmod - 使用集群上的软件</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-docs/docs/users/software/easybuild">EasyBuild - 软件安装工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-docs/docs/users/software/software-list">公共软件列表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-docs/docs/users/software/anaconda">Anaconda - Python包管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cluster-docs/docs/users/software/tools">常用工具</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/slurm/basics">使用计算资源</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/debug/introduction">调试</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/profile/scorep">性能分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cluster-docs/docs/users/question_and_answer">Q&amp;A</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cluster-docs/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">软件与工具</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Spack - 使用集群上的软件</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spack - 使用集群上的软件</h1></header><p>Spack是一个为超算平台设计的包管理工具，它能较好地处理依赖关系，用法上类似于 Lmod、Anaconda。
目前，Spack 0.16.0 支持 Linux 和 macOS 两种系统，可以安装 C/C++、Fortran、Python、R 等语言的软件包。</p><p>在实验室集群上，Spack 可以用来替代 EasyBuild &amp; Lmod 进行软件包/环境管理。<br>
<!-- -->Spack 的主要特点如下：</p><ul><li><strong>查询</strong>：软件信息，包括版本、依赖项等；</li><li><strong>加载</strong>：动态加载、卸载、更换软件（相当于 <code>module load/unload/swap</code>）；</li><li><strong>安装</strong>：安装软件、软件栈，处理软件的依赖关系；</li><li><strong>删除</strong>：删除软件及其依赖；</li><li><strong>多用户</strong>：设计了有优先级的配置文件，用户级配置可以覆盖系统配置文件；</li><li><strong>兼容性</strong>：可以导出 Lmod 或 Tcl 格式的 modulefiles；</li><li><strong>易于迁移</strong>：可以方便的添加软件的 repos、mirrors，也可以自定义新的软件，支持 docker。</li></ul><p>相关参考资料和链接如下：<br>
<!-- -->Spack官方网站：<a href="https://spack.io/" target="_blank" rel="noopener noreferrer">https://spack.io/</a><br>
<!-- -->Spack 101: <a href="https://spack-tutorial.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">https://spack-tutorial.readthedocs.io/en/latest/</a><br>
<!-- -->Spack工作流：<a href="https://spack.readthedocs.io/en/latest/workflows.html" target="_blank" rel="noopener noreferrer">https://spack.readthedocs.io/en/latest/workflows.html</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="快速入门">快速入门<a class="hash-link" href="#快速入门" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 配置和加载 Spack 环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">SPACK_ROOT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/apps/spack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">source</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$SPACK_ROOT</span><span class="token plain">/share/spack/setup-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看已安装的编译器，有的软件会同时存在依赖不同编译器的多个版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack compilers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看已安装的软件及版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> openmpi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load cmake openmpi%gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看已加载的软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> --loaded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cmake --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mpicc --version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 卸载当前加载的所有软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack unload -a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>切换 Spack 环境</h5></div><div class="admonition-content"><p>如果机器上配置了多个 Spack，切换 Spack 环境时直接使用 <code>source setup-env.sh</code> 可能不会生效。
问题在于该脚本会检查 <code>PATH</code> 变量里面是否已经有 Spack 路径，并且该脚本定义了几个变量、函数可能不会被新脚本覆盖。
最简单的办法就是在 <code>source</code> 之前，用 <code>env</code> 检查一下自己的环境，从 <code>PATH</code> 里去掉 Spack 路径，并删除 Spack 定义的函数。</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="rosetta-stone从-module-到-spack">Rosetta Stone：从 <code>module</code> 到 <code>spack</code><a class="hash-link" href="#rosetta-stone从-module-到-spack" title="Direct link to heading">​</a></h3><table><thead><tr><th></th><th>Module System</th><th>Spack</th></tr></thead><tbody><tr><td>查询可用软件</td><td><code>module avail</code><br><code>module avail CMake</code><br><code>module spider</code></td><td><code>spack find</code><br><code>spack find cmake</code></td></tr><tr><td>列出已加载软件</td><td><code>module list</code></td><td><code>spack find --loaded</code></td></tr><tr><td>加载软件</td><td><code>module load CMake/3.19</code><br><code>module add CMake/3.19</code></td><td><code>spack load cmake@3.19</code></td></tr><tr><td>卸载软件</td><td><code>module unload CMake/3.19</code><br><code>module rm CMake/3.19</code></td><td><code>spack unload cmake@3.19</code></td></tr><tr><td>清空已加载软件</td><td><code>module purge</code></td><td><code>spack unload -a</code></td></tr><tr><td>仅加载依赖项</td><td>无</td><td><code>spack load --only dependencies cmake@3.19</code></td></tr><tr><td>切换版本</td><td><code>module swap CMake/3.19 CMake/3.18</code></td><td>无，先卸载再加载</td></tr><tr><td>查看说明</td><td><code>module help CMake/3.19</code></td><td><code>spack info cmake</code></td></tr><tr><td>查看配置文件</td><td><code>module show CMake/3.19</code></td><td><code>spack edit cmake</code></td></tr><tr><td>查看安装路径</td><td><code>module show CMake/3.19</code></td><td><code>spack location -i cmake@3.19</code><br><code>spack find --paths cmake@3.19</code></td></tr><tr><td>查看依赖关系</td><td>查看手动加载的依赖<br><code>module spider CMake/3.19</code><br>查看可自动加载的依赖<br><code>module show CMake/3.19</code></td><td><code>spack find -d cmake@3.19</code><br><code>spack dependencies -i cmake@3.19</code><br><code>spack dependents -i cmake@3.19</code></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_mojV" id="基本概念">基本概念<a class="hash-link" href="#基本概念" title="Direct link to heading">​</a></h2><p>在使用 Spack 之前，建议先熟悉 Spack 中的相关概念，如包的命名规则。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="公共-spack">公共 Spack<a class="hash-link" href="#公共-spack" title="Direct link to heading">​</a></h3><p>公共 Spack 指的是由管理员安装在实验室集群上的 Spack，仅管理员有写权限。</p><p>普通用户不能用公共 Spack</p><ul><li>安装或删除软件；</li><li>修改集群的 Spack 配置文件；</li><li>创建 Spack 虚拟环境（因为虚拟环境路径无法修改）。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="用户级-spack">用户级 Spack<a class="hash-link" href="#用户级-spack" title="Direct link to heading">​</a></h3><p>用户级 Spack（或者本地 Spack）指的是由用户自行安装在家目录下的 Spack，用户对该 Spack 拥有完全的读写权限。用户级 Spack 默认情况下无法用于加载集群上安装的软件，需要进行相关配置将它连接到公共 Spack。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="spec">spec<a class="hash-link" href="#spec" title="Direct link to heading">​</a></h3><p>参考：<a href="https://spack.readthedocs.io/en/latest/basic_usage.html#specs-dependencies" target="_blank" rel="noopener noreferrer">Specs &amp; dependencies</a></p><p>在 Spack 中，每个软件包都由一个 <em>spec</em>（specification）唯一表示。一个 spec 中包含了软件名称、版本、选项、编译器 spec、依赖项 spec 等，也就是说，它是递归定义的。
spec 中信息的改变会导致软件包的 hash 值发生变化，也就是说，只要 spec 中有关键信息变了，就会被视为新的 spec，在安装时会被当作新的软件包。</p><p>spec 的语法可以查阅参考文档，也可以在机器上用命令查看</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token builtin class-name">help</span><span class="token plain"> --spec</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="add-concretize-install">add, concretize, install<a class="hash-link" href="#add-concretize-install" title="Direct link to heading">​</a></h3><p>Spack 将软件包的管理分为多个阶段：</p><ul><li><em>add</em>：添加 spec，通常仅仅修改配置文件</li><li><em>concretize</em>：完成 spec 检索、依赖项解析等工作，可能会修改配置文件（包括<code>.lock</code>文件），这个过程也会发现已安装的软件包、有冲突的 specs</li><li><em>install</em>：完成下载、编译安装、索引生成等工作，结束后用户便可使用软件包</li></ul><p>用户使用 <code>spack install</code> 时，所有阶段都会执行。只有在使用 Spack 虚拟环境时，用户才能手动执行各个阶段。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="environment">environment<a class="hash-link" href="#environment" title="Direct link to heading">​</a></h3><p>参考：<a href="https://spack.readthedocs.io/en/latest/environments.html" target="_blank" rel="noopener noreferrer">Environments</a></p><p>熟悉 Python 的应该都了解虚拟环境，Spack 也提供了对虚拟环境（在 Spack 中称为 <em>environments</em>）的支持。
Spack 提供的虚拟环境与 Anaconda 的虚拟环境功能类似。<br>
<!-- -->Spack的环境可以用于批量操作软件包 specs，也可以用于管理文件系统视图，以及像 Anaconda 的虚拟环境一样激活、反激活，一次性加载其中的所有软件包等。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="view">view<a class="hash-link" href="#view" title="Direct link to heading">​</a></h3><p>参考：<a href="https://spack.readthedocs.io/en/latest/workflows.html#filesystem-views" target="_blank" rel="noopener noreferrer">Filesystem Views</a></p><p>Spack 的文件系统视图（<em>filesystem views</em>）是一种帮助用户批量使用软件包的方式。它可以为指定的软件包建立软/硬链接，按照Linux的目录结构来组织。例如，为指定的一些软件在目录 <code>myview/</code> 建立文件系统视图后，该目录内容通常包含</p><ul><li><code>myview/bin</code>：存放所有指定软件包的<code>bin/*</code></li><li><code>myview/lib</code>：存放所有指定软件包的<code>lib/*</code></li><li><code>myview/include</code>：存放所有指定软件包的<code>include/*</code></li></ul><p>从上述说明可知，一个文件系统视图中通常不能有两个同名软件包，否则无法创建。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="查询软件包">查询软件包<a class="hash-link" href="#查询软件包" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/basic_usage.html#seeing-installed-packages" target="_blank" rel="noopener noreferrer">Seeing installed packages</a></li><li><a href="https://spack.readthedocs.io/en/latest/basic_usage.html#specs-dependencies" target="_blank" rel="noopener noreferrer">Specs &amp; dependencies</a></li></ul><p>用于查询软件包的相关命令有： </p><ul><li><code>spack find</code>：查看已安装软件</li><li><code>spack info</code>：查看软件的介绍，包括版本、选项等</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="spack-find"><code>spack find</code><a class="hash-link" href="#spack-find" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 列出所有已安装的软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 列出指定名称的软件包，可能会搜出多个同名软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> hdf5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &#x27;@&#x27;用于指定软件包版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> hdf5@1.10.7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &#x27;%&#x27;用于指定编译器，编译器后面可接&#x27;@&#x27;继续限定编译器版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> hdf5@1.10.7%gcc@10.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &#x27;^&#x27;用于指定依赖项，可以有多个</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> hdf5@1.10.7%gcc ^openmpi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># &#x27;+&#x27;、&#x27;~&#x27;或&#x27;=&#x27;用于指定编译该软件包所用的选项（称为variants）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> hdf5@1.10.7 +mpi ~fortran</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看软件包的编译选项和依赖项，并且注明编译器的版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> -vd --show-full-compiler hdf5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看软件包的hash值和安装路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 虽然这些软件包是同名、同版本的，但它们的编译选项、编译器、依赖项各不相同，因此</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 有不同的spec，产生不同的hash值。hash值也可以在加载软件包的时候使用。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> -L --paths hdf5</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Spack把安装的软件包按照架构（target）和编译器（compiler/compiler driver）分类。在目前的集群Spack中，架构统一为x86_64，这是为了兼容集群中不同型号的处理器。</p><p>使用 <code>spack find</code> 可以看到，不同编译器下面会有同名的软件包。例如，查看已安装的所有 <code>mpi</code> 包如下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># mpi属于virtual package，查询它就会显示所有提供mpi的包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> mpi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> installed packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- linux-centos7-x86_64 / clang@11.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mpich@3.3.2  openmpi@4.0.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- linux-centos7-x86_64 / gcc@10.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mpich@3.3.2  openmpi@4.0.5</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="spack-info"><code>spack info</code><a class="hash-link" href="#spack-info" title="Direct link to heading">​</a></h3><p>如果对于某一软件不熟悉，或者不清楚该软件的编译选项有什么含义，可以使用 <code>spack info</code> 来确认。</p><p>该命令会显示软件包的帮助信息，包括简介、版本、下载地址、编译选项说明、编译安装阶段说明、依赖项列表等。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack info openmpi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="加载卸载软件包">加载/卸载软件包<a class="hash-link" href="#加载卸载软件包" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/basic_usage.html#using-installed-packages" target="_blank" rel="noopener noreferrer">Using installed packages</a></li><li><a href="https://spack.readthedocs.io/en/latest/build_systems/bundlepackage.html" target="_blank" rel="noopener noreferrer">Bundle package</a></li></ul><p>用于加载/卸载软件包的命令分别如下：  </p><ul><li><code>spack load</code>：加载软件包</li><li><code>spack unload</code>：卸载软件包</li></ul><p>通过 Spack 使用软件包和 Environment Module 的用法类似，分为加载和卸载两个命令。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 加载软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载软件包，并同时加载它的所有依赖（非必需）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load -r cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 卸载软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack unload cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 卸载当前所有已加载的软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack unload -a</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>除了普通的软件包，集群上还定义了一些 <em>bundle package</em>，也就是一组软件，主要用于代替 Easybuild &amp; Lmod 的 <em>toolchain</em>，把常用编译工具放在一起。这些软件包的版本号也类似于 toolchain：年份+字母。例如，<code>gompi@2020b</code> 就包含了 <code>gcc</code> 和 <code>openmpi</code>，软件的安装时间为2020年下半年。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> gompi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load gompi@2020b</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>关于依赖项</h5></div><div class="admonition-content"><p>使用 Spack 安装的软件都会尽可能用 <strong>RPATH</strong>，依赖项的位置会写在二进制文件里。
因此通常不需要加载依赖项就可以使用软件包。
例如，使用 <code>openmpi%gcc@10.2.0</code> 时，不需要加载 <code>gcc@10.2.0</code> ，mpicc 会指向正确的 gcc 位置。</p></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>环境变量的修改</h5></div><div class="admonition-content"><p><code>spack load / unload</code> 默认会影响的环境变量在不同版本可能会不一样。例如，从 v0.16.1 的某个开发版起，默认只修改 <code>PATH</code>、<code>MANPATH</code>、<code>CPATH</code> 和 <code>LD_LIBRARY_PATH</code>，而不会修改 <code>LIBRARY_PATH</code>。依赖于 <code>LIBRARY_PATH</code> 的用户需要调整配置文件 <code>modules.yml</code> 中的 <code>prefix_inspections</code>：</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">modules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prefix_inspections:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lib:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - LIBRARY_PATH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lib64:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - LIBRARY_PATH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>参考：<a href="https://spack.readthedocs.io/en/latest/module_file_support.html#customize-env-modifications" target="_blank" rel="noopener noreferrer">Customize environment modifications</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="加载-python-包">加载 Python 包<a class="hash-link" href="#加载-python-包" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/basic_usage.html#extensions-python-support" target="_blank" rel="noopener noreferrer">Extensions &amp; Python support</a></li></ul><p>Spack 中用于加载 Python 包的命令为：</p><ul><li><code>spack extensions</code>：列出 Python 包</li></ul><p>Spack 把 Python 包归为 <em>extensions</em>，可以通过相应的命令查看 Python 包列表。
Python 包的加载有多种方式，这里只介绍最简单的方式。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看所有已安装的Python包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack extensions -s installed python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看目前已加载的Python包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack extensions -s activated python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载Python和想用的Python包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load py-numpy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用Python包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> numpy</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>集群预装的 Spack 环境</h5></div><div class="admonition-content"><p>如果对 Python 包的版本没有特殊要求，可以使用预装的 Spack 环境：
<code>spack env activate python3</code>。
关于 Spack 环境的说明见后续内容。</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="使用文件系统视图">使用文件系统视图<a class="hash-link" href="#使用文件系统视图" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/workflows.html" target="_blank" rel="noopener noreferrer">Workflows - Filesystem views</a></li></ul><p>用于创建、修改文件系统视图的命令为：</p><ul><li><code>spack view</code></li></ul><p>Spack 安装的所有软件包都按照 Spack 的命名规则存放在同一目录下，但我们也可以建立文件系统视图，将某些软件包的文件聚在一起。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 在指定目录中为软件包建立软链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack view </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/data/mytools petsc%gcc scorep%gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将软链接所在目录添加到环境变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable environment constant" style="color:#36acaa">PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/data/mytools/bin:</span><span class="token environment constant" style="color:#36acaa">$PATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">LIBRARY_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/data/mytools/lib:</span><span class="token variable" style="color:#36acaa">$LIBRARY_PATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">LD_LIBRARY_PATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/data/mytools/lib:</span><span class="token variable" style="color:#36acaa">$LD_LIBRARY_PATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">CPATH</span><span class="token operator" style="color:#393A34">=</span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/data/mytools/include:</span><span class="token variable" style="color:#36acaa">$CPATH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 不再使用时，删除所有软链接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack view remove --all </span><span class="token environment constant" style="color:#36acaa">$HOME</span><span class="token plain">/data/mytools</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="使用虚拟环境">使用虚拟环境<a class="hash-link" href="#使用虚拟环境" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/environments.html#using-environments" target="_blank" rel="noopener noreferrer">Using environments</a></li></ul><p>用于管理虚拟环境的主要命令有：</p><ul><li><code>spack env</code>：创建、修改虚拟环境（需要写权限）</li><li><code>spack add</code>：在虚拟环境中添加抽象 specs（仅添加到配置文件）</li><li><code>spack concretize</code>：对所有 specs 执行 <code>concretize</code>（检查、解析依赖等，可能会格式化配置文件）</li><li><code>spack install</code>：安装所有 concretized specs</li></ul><p>Spack：</p><ul><li>用户级</li></ul><p>同一个环境里的 specs 可以批量操作，可使用的操作（阶段）为：</p><ul><li><em>add</em>：批量添加 specs，但不执行后续操作</li><li><em>concretize</em>：批量 concretize，解析所有依赖</li><li><em>install</em>：批量下载、编译安装</li></ul><p>把 specs 组织成多个环境既有助于我们管理软件包，也有助于我们切换不同开发环境需求的环境变量。</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>要注意的是，操作 Spack 的虚拟环境需要写权限，普通用户只能修改用户级 Spack（关于用户级 Spack的配置见后续内容），不能修改集群的公共 Spack。</p></div></div><p>Spack 环境的简单用法如下：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 创建一个名为python3的空环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> create python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看目前有哪些环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 激活Spack环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> activate python3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看当前位于哪个环境中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看当前环境中有哪些软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 添加一些抽象specs到环境中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> py-numpy py-h5py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 执行concretize，解析所有依赖</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack concretize --force</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 已安装的specs会直接加到环境中，若对concretize的结果不满意，可以修改specs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 一个环境只有一个配置文件，其他诸如packages等配置作为子节点写在其中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config edit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看目前concretize的结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 安装所有软件包及依赖项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">install</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>创建 Spack 环境时，默认也会创建一个文件系统视图，该环境的所有软件包都会加到这个视图中管理。
这种情况下，文件系统视图的限制也同样作用于 Spack 环境。
激活环境时，Spack 会根据文件系统视图管理的各个路径为我们设置相应环境变量。
如果该环境中某些软件包没有正确加载，可以使用 <code>spack load</code> 命令手动加载一下。</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>集群 Spack 预定义的环境</h5></div><div class="admonition-content"><p>集群 Spack 中可能会预先定义一些只读的环境，如 <code>python3</code>，它们通常是一些常用的软件包，只有在使用集群的公共 Spack 时才可以加载：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">env</span><span class="token plain"> activate python3</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>如果需要定制 Spack 环境，请配置用户级 Spack。</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="配置用户级-spack">配置用户级 Spack<a class="hash-link" href="#配置用户级-spack" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/getting_started.html#prerequisites" target="_blank" rel="noopener noreferrer">Prerequisites</a></li><li><a href="https://spack.readthedocs.io/en/latest/chain.html" target="_blank" rel="noopener noreferrer">Chaining spack installations</a></li><li><a href="https://spack.readthedocs.io/en/latest/configuration.html" target="_blank" rel="noopener noreferrer">Configuration files</a></li><li><a href="https://spack.readthedocs.io/en/latest/build_settings.html#concretization-preferences" target="_blank" rel="noopener noreferrer">Concretization preferences</a></li></ul><p>相关命令：</p><ul><li><code>spack config</code>：查看、修改 Spack 配置文件</li><li><code>spack compiler</code>：查看、查找编译器</li></ul><p>实验室集群只安装了一个公共的 Spack，位于<code>/apps/spack</code>，它其中的软件包由管理员维护，普通用户不能在里面增加新的软件包。</p><p>为了完全使用 Spack 的功能（例如安装自己需要的包），需要在自己的目录下安装 Spack 并做一些配置。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="安装-spack">安装 Spack<a class="hash-link" href="#安装-spack" title="Direct link to heading">​</a></h3><p>根据 Spack 文档，运行 Spack 0.16.0 需要以下依赖：</p><ul><li>Python 2 (2.6 or 2.7) 或 3 (3.5 - 3.9)，用于运行Spack；</li><li>C/C++编译器，用于软件包的编译链接；</li><li><code>make</code>，用于软件包的编译链接；</li><li><code>tar</code>、<code>gzip</code>、<code>bzip2</code>、<code>xz</code>、可选的<code>zstd</code>，用于解压下载的压缩包；</li><li><code>patch</code>，用于给软件包打补丁；</li><li><code>git</code>或<code>curl</code>，用于在缺少软件包时下载其源代码；</li><li>可选的<code>gnupg2</code>，用于GPG。</li></ul><p>由于 Spack 基本都是 Python，我们只需要克隆它的仓库、添加 Python 路径便可使用。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 克隆Spack仓库到自己目录下</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">SPACK_ROOT</span><span class="token operator" style="color:#393A34">=~</span><span class="token plain">/data/spack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/spack/spack </span><span class="token variable" style="color:#36acaa">$SPACK_ROOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载用户级 Spack环境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">.</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$SPACK_ROOT</span><span class="token plain">/share/spack/setup-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查一下是否能找到Spack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> spack</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="连接到公共-spack">连接到公共 Spack<a class="hash-link" href="#连接到公共-spack" title="Direct link to heading">​</a></h3><p>准备好 Spack 仓库之后，我们首先连接公共 Spack，这样便可以通过自己的 Spack 使用集群上现有的软件。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 将公共Spack作为upstream。编辑配置文件，修改为如下三行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config edit upstreams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upstreams.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> upstreams:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   spack-instance-public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">       install_tree: /apps/spack/opt/spack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查 upstreams</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config get upstreams</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="修改其他配置文件">修改其他配置文件<a class="hash-link" href="#修改其他配置文件" title="Direct link to heading">​</a></h3><p>除了<code>upstreams.yaml</code>，我们还可以修改其他配置文件来充分利用集群上已有的数据：</p><ul><li>添加 compilers：添加集群现有的编译器到用户级 Spack（推荐）</li><li>修改 target：修改软件包的默认 target 为 x86_64（可选）</li><li>添加 repos：集群的 repo 会包含自定义软件包（可选）</li><li>添加 mirrors：凡是集群安装过的软件都不用重复下载（可选）</li></ul><p>为用户级 Spack 修改配置的具体步骤如下：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 按需添加编译器，只要先加载编译器所在的软件包，再执行添加命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 例如，我们想添加集群 Spack 的 gcc 和 clang</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load gcc llvm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack compiler </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查 compilers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack compiler list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config get compilers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置默认 target 为通用x86_64。编辑配置文件，修改为如下三行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config edit packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   all:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">     target: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x86_64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 添加集群的软件包 repo。编辑配置文件，增加两项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config edit repos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">repos.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> repos:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   - /apps/repos/spack/hpcde</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">   - /apps/repos/spack/flipped</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查 repos</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack repo list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 编辑配置文件，添加镜像位置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config edit mirrors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mirrors.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> mirrors:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   cluster-public: file:///apps/sources/spack</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 检查 mirrors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config get mirrors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 配置完成，查看已安装的软件包，包括公共的和用户级的 Spack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">find</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>完成配置后，可以随意安装、删除用户级 Spack 的软件包。有关安装路径、外部软件包等设置，请参考 Spack 配置文件的手册。</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>关于软件包的优先级</h5></div><div class="admonition-content"><p>如果公共 Spack 和用户级 Spack 存在相同的软件包，用户级的会优先被选择。</p></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Spack 版本的影响</h5></div><div class="admonition-content"><p>不同 Spack 版本在安装软件包时，包的默认版本不同。
例如，集群 Spack 安装的 <code>cmake</code> 可能是 3.19.0，用户级 Spack 中的默认 <code>cmake</code> 却是 3.19.1，导致默认情况下不会使用集群的 <code>cmake</code>。</p><ul><li>解决方法一：把用户级的 Spack 仓库切换到和集群 Spack 相同的 git 分支。要获知集群 Spack 在哪个分支，使用集群 Spack 执行 <code>spack debug report</code></li><li>解决方法二：在安装软件包时额外指定依赖的版本，例如 <code>^cmake@3.19.1</code> 。</li><li>解决方法三：在配置文件 <a href="https://spack.readthedocs.io/en/latest/build_settings.html#build-settings" target="_blank" rel="noopener noreferrer">packages.yaml</a> 中设置某个版本为优先。</li></ul></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Fortran 编译器</h5></div><div class="admonition-content"><p>有的软件包可能会强制要求 Fortran 编译器（与 Spack 版本有关），而 <code>llvm</code> 是没有 Fortran 编译器的。遇到这种情况时，暂时的解决办法如下：</p><ul><li>打开 <code>compilers.yaml</code>，找到 <code>clang</code> 对象；</li><li>修改其中的 <code>f77</code> 和 <code>fc</code> 值为可用的 Fortran 编译器路径，例如 <code>gfortran</code> 路径。</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="安装删除软件包">安装/删除软件包<a class="hash-link" href="#安装删除软件包" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/basic_usage.html#installing-and-uninstalling" target="_blank" rel="noopener noreferrer">Installing and uninstalling</a></li><li><a href="https://spack.readthedocs.io/en/latest/packaging_guide.html#dependency-types" target="_blank" rel="noopener noreferrer">Dependency types</a></li></ul><p>安装或删除软件包的相关命令有：</p><ul><li><code>spack list</code>：查看可安装的软件包</li><li><code>spack spec</code>：查看软件包的spec，包括编译选项、依赖项等</li><li><code>spack install</code>：安装软件包</li><li><code>spack uninstall</code>：解除安装（删除）</li><li><code>spack dependents</code>：列出依赖于某个包的软件包</li><li><code>spack gc</code>：垃圾回收，清理依赖项</li><li><code>spack mark</code>：标记软件包，显式要求或防止被清理</li><li><code>spack clean</code>：清理临时文件，也可删除下载的源文件</li></ul><p>Spack：</p><ul><li>用户级</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="工作流">工作流<a class="hash-link" href="#工作流" title="Direct link to heading">​</a></h3><p>配置好用户级 Spack 并连接到集群 Spack 后，我们可以在本地安装自己需要的软件包。安装软件的一般流程如下</p><ul><li>检查软件包是否存在</li><li>确认软件包的版本、编译选项</li><li>确认软件包的依赖项</li><li>安装软件包</li><li>清理依赖</li><li>删除软件包</li></ul><p>假设我们要用集群 Spack 的 <code>gcc</code> 来安装一个低版本 <code>cmake</code>，演示如下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 检查软件包是否存在，若不存在，可考虑spack create来创建</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># spack list支持通配符，传参时用引号引起来，如&#x27;*make&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack list cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 确认软件包的版本、编译选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack info cmake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看软件包的完整spec，为已安装的软件包显示特殊标记</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack spec -It cmake@3.15.0 %gcc@10.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 安装软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> cmake@3.15.0 %gcc@10.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 清理运行时不需要的依赖项，主要是仅用于build的工具</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack gc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 若不再使用，可删除已安装的软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># spack uninstall cmake@3.15.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 清理build产生的临时文件、下载的源文件（源文件可重复利用，不建议清除）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack clean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack clean -d</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="清理依赖项">清理依赖项<a class="hash-link" href="#清理依赖项" title="Direct link to heading">​</a></h3><p><code>spack gc</code>可清理的主要是 build-time 依赖和 test 依赖，它们不会链接到安装的软件包中，也不会在运行时被调用。</p><p>一个软件包的依赖有四种类型：build、link、run、test。使用命令可以看到所有依赖对应的类型：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack spec -t cmake</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>除了特定类型的依赖不会被清理，我们也可以手动标记软件包，让GC不要清理：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack mark -e ncurse</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>spack gc</code> 和 <code>spack uninstall</code> 都会考虑依赖项。使用 <code>spack uninstall</code> 时，如果要删除的包是其他某个软件包的依赖，Spack 会给出提示。我们也可以事先用命令确认一下一个软件包到底被哪些软件包使用着。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 列出已安装的软件包中依赖于zlib的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 一定要带上参数-i限制范围在已安装的软件包，否则会搜索所有可安装的软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack dependents -i zlib</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="仅安装依赖">仅安装依赖<a class="hash-link" href="#仅安装依赖" title="Direct link to heading">​</a></h3><p><code>spack install</code> 默认会安装软件包及其依赖。如果用户需要的只是依赖项，希望自己编译特定的程序，可用参数 <code>--only</code> 来指定：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> --only dependencies petsc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><code>spack load</code> 也有同样的参数用于仅加载依赖项：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load --only dependencies petsc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>只有依赖项的 spec</h5></div><div class="admonition-content"><p>实验室集群上的 <code>gompi</code>、<code>gmpich</code> 等软件包都是只有依赖项的 bundle package，它们和文件系统视图、虚拟环境都可以用于批量管理常用软件包。
用户也可以为自己常用的工具集创建 bundle package。</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="让spack使用外部软件包">让Spack使用外部软件包<a class="hash-link" href="#让spack使用外部软件包" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack.readthedocs.io/en/latest/build_settings.html#external-packages" target="_blank" rel="noopener noreferrer">External packages</a></li></ul><p>相关命令：</p><ul><li><code>spack config</code>：操作配置文件</li><li><code>spack install</code>：安装软件包</li><li><code>spack external find</code>：搜索可用的外部软件包</li></ul><p>Spack：</p><ul><li>用户级</li></ul><p>Spack 很擅长编译安装软件包，我们通常不需要关心装一个东西需要多少依赖，也不用关心一个依赖是不是反复被 gc 又反复被 build，完全可以全部交给 Spack。</p><p>不过我们也可能会有不需要 Spack 来安装的、已经存在的软件包。比如，集群上的默认 <code>gcc</code> 和 <code>slurm</code> 都在系统路径里，不需要Spack来安装；用户安装在家目录的软件包也不一定需要重复安装。对于这些软件包，我们只需要分配 specs，让 Spack 把它们当成普通的软件包来处理就行。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="externals"><code>externals</code><a class="hash-link" href="#externals" title="Direct link to heading">​</a></h3><p>为了利用已有的软件包，我们可以使用 <em>external packages</em>。只要给已经存在的软件拟定一个 spec，并把 spec 连同软件的路径写在配置文件 <code>packages.yaml</code> 的 <code>externals</code> 中，它们就能正常被 Spack 加载。此外，我们还能禁止 Spack 重新安装它们。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 假设我们已经在/apps/software/Boost/底下安装了boost，想放在Spack里使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 编辑配置文件如下</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config edit packages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">packages.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> packages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   boost:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">     buildable: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">     externals:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">     - spec: boost@1.70.0-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">       prefix: /apps/software/Boost/1.70.0-gompi-2019a/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 添加这个外部软件包到Spack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> boost@1.70.0-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 像普通Spack软件包一样使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack load boost@1.70.0-system</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在这个例子中，我们在配置文件里增加了一个外部软件包，指定了它的名字、版本和路径。同时，我们将 <code>buildable</code> 设置为 <code>false</code>，禁止 Spack 安装其他版本的 <code>boost</code>，仅使用我们自己提供的版本。</p><p><code>externals</code>中可以同时定义多个 specs，唯一限制就是 specs 不能完全相同。</p><p>对于一个外部软件包，我们可以通过两种方式为它指明路径：</p><ul><li><code>prefix</code>：给定搜索路径，也就是前面的例子演示的；</li><li><code>modules</code>：给定加载的模块，当系统上有模块系统时可以直接利用已有模块。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="搜索外部软件包">搜索外部软件包<a class="hash-link" href="#搜索外部软件包" title="Direct link to heading">​</a></h3><p>当我们不清楚软件包的具体位置时，可以用命令来搜索外部软件包，不过这种方式需要软件包的配置文件提供可供搜索的内容（Spack v0.16.0 只支持搜索可执行文件）。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 搜索系统已有的openmpi软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack external </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> openmpi</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="外部软件包的依赖">外部软件包的依赖<a class="hash-link" href="#外部软件包的依赖" title="Direct link to heading">​</a></h3><p>外部软件包可能是由其他包管理软件安装的，也可能是由用户手动编译安装的，它们也有自己的依赖。</p><p>比如，编译安装 <code>openmpi</code> 时，可能会依赖于某个路径下的 <code>hwloc</code>。在添加该 <code>openmpi</code> 为 Spack 外部软件包时，一定要尽量让编译的 <code>openmpi</code> 使用 RPATH，即把依赖的路径硬编码在二进制文件中。否则，在加载时很可能被动态链接到其他版本的 <code>hwloc</code>，产生不易发现的错误。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="可供参考的配置">可供参考的配置<a class="hash-link" href="#可供参考的配置" title="Direct link to heading">​</a></h3><p>集群的公共 Spack 配置了许多外部软件包，用户可以参考该配置文件来写自己的配置。其路径为</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/apps/spack/etc/spack/packages.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>在加载了公共 Spack 时也可用命令查看</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config --scope site get packages</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>实验室集群上软件包的路径</h5></div><div class="admonition-content"><p>用户为 Spack 配置外部软件包时，可能会涉及多个分散的软件安装路径。主要的路径和所在节点列在这里以供参考</p><ul><li><code>$HOME</code>：位于登录节点，用户可能有自己安装的软件；</li><li><code>$HOME/data</code>：位于数据节点，用户可能有自己安装的软件；</li><li><code>/opt</code>：位于登录节点，存放的多是手动安装的软件；</li><li><code>/apps/software</code>：位于软件安装节点，存放的是由 EasyBuild 安装或手动安装的软件；</li><li><code>/apps/spack/opt/spack</code>：位于软件安装节点，存放的是由公共 Spack 安装的软件；</li></ul></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="模块文件">模块文件<a class="hash-link" href="#模块文件" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><a href="https://spack-tutorial.readthedocs.io/en/latest/tutorial_modules.html" target="_blank" rel="noopener noreferrer">Module file tutorial</a></li><li><a href="https://spack.readthedocs.io/en/latest/module_file_support.html" target="_blank" rel="noopener noreferrer">Modules</a></li></ul><p>Spack 中用于操作模块文件的相关命令为：</p><ul><li><code>spack module</code></li></ul><p>Spack：</p><ul><li>用户级</li></ul><p>Spack 加载软件包的速度比 Lmod 要慢，好在它提供了两种简单的方式让我们能快速加载想要的环境，分别为: </p><ul><li><code>spack view</code>：建立文件系统视图，前面已经介绍过</li><li><code>spack module</code>：为软件包创建 modulefiles，之后便可通过<code>module</code>加载</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="生成-modulefiles">生成 modulefiles<a class="hash-link" href="#生成-modulefiles" title="Direct link to heading">​</a></h3><p>Spack 能够为 <code>lmod</code> 和 <code>tcl</code> 两种类型模块系统创建 modulefiles，在实验室集群上，两种均可以使用。我们以 <code>lmod</code> 为例。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 为某些软件包创建modulefiles</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack module lmod refresh autoconf automake boost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建完成后，可以通过module查看这些modulefiles</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># module avail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 也可以直接用Spack查看</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack module lmod </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> boost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boost/1.70.0-d42gtzk</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="加载模块">加载模块<a class="hash-link" href="#加载模块" title="Direct link to heading">​</a></h3><p>截至 Spack v0.16.0，对模块系统的支持仍然有许多问题，比如模块的依赖关系。Spack 虽然自己能很好地处理软件包依赖关系，但无法很好地反映到它生成的模块文件中，尤其是 Tcl 模块文件中。</p><p>为了避免使用模块时遇到缺少依赖项的情况，我们要尽量使用 Spack 的工具来生成模块加载命令，它可以导出所有依赖。</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 用Spack命令为软件包批量生成module load命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 该命令会打印出一堆module load，我们可以放在脚本中使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack module lmod loads boost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module load boost/1.70.0-d42gtzk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 使用时最好加上参数，为依赖项也生成module load命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack module lmod loads -r boost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module load bzip2/1.0.8-t3oih6b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module load zlib/1.2.11-apt6zkj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module load boost/1.74.0-n5fwgzn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 也可以仅生成模块列表，用户自行将它作为module load的输入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack module lmod loads -r --input-only boost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bzip2/1.0.8-t3oih6b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zlib/1.2.11-apt6zkj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boost/1.74.0-n5fwgzn</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="modulesyaml"><code>modules.yaml</code><a class="hash-link" href="#modulesyaml" title="Direct link to heading">​</a></h3><p>默认情况下，Spack 生成的模块文件名称中包含 hash 值，但我们可能需要意义更加明确的模块名称。Spack 提供了配置文件 <code>modules.yaml</code> 来控制模块文件的生成过程，它大致包含以下几个部分：</p><ul><li>命名规则：统一调整软件包的命名规则，或者筛选一部分软件包调整它们的命名规则；</li><li>黑名单/白名单：控制哪些模块可以生成、哪些不能生成；</li><li>环境变量：指明加载某些模块时应该同时设置哪些环境变量；</li><li>其他与模块文件相关的特性：对应于 <code>lmod</code> 和 <code>tcl</code> 模块文件语法的一些设置，比如 <code>conflicts</code>。</li></ul><p>配置文件的具体编写方法可参考 Spack 官方文档。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="自定义软件包">自定义软件包<a class="hash-link" href="#自定义软件包" title="Direct link to heading">​</a></h2><p>参考：</p><ul><li><p><a href="https://spack-tutorial.readthedocs.io/en/latest/tutorial_packaging.html" target="_blank" rel="noopener noreferrer">Package creation tutorial</a></p></li><li><p><a href="https://spack.readthedocs.io/en/latest/packaging_guide.html" target="_blank" rel="noopener noreferrer">Packaging guide</a></p></li></ul><p>相关命令：</p><ul><li><code>spack create</code>：创建软件包的配置文件</li><li><code>spack edit</code>：编辑软件包的配置文件</li><li><code>spack cd</code>：切到上一次的软件包build目录</li><li><code>spack build-env</code>：手动build软件包</li></ul><p>Spack：</p><ul><li>用户级</li></ul><p>Spack 可安装的每个软件包都有相应的 Python 配置文件，每个包都是 Spack 定义的某个类的实例。目前，Spack 内置了5000多个软件包（0.16），大多是常用的开发工具、数值计算软件，不过这并不能完全满足我们的需求。</p><p>当我们使用 <code>spack list</code> 找不到想要的软件包时，我们可以自己写配置文件。一般流程如下：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 根据软件包的下载地址，提取名称、版本等信息自动生成配置文件草稿</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack create https://url/to/package</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 配置文件在生成后会自动被打开，若没有打开，可以使用edit命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack edit </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">package name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 调整配置文件后，使用Spack安装该软件包</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">package name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 如果安装失败，可以切换到刚刚的build目录手动处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack </span><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">package name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 手动build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack build-env </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">package name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 也可以直接使用make等工具</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">make</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 反复调整配置文件直到能够成功安装</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># spack install &lt;package name&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>编写配置文件</h5></div><div class="admonition-content"><p><code>package.py</code> 文件的写法可参考 Spack 文档或使用 <code>spack edit</code> 参考现有文件。
要注意的是，修改依赖较多的软件包的 <code>package.py</code> 文件时，记得时常用 <code>spack spec</code> 检查配置的正确性。
<code>spack spec</code>实际上会调用 concretize 算法，在某些错误配置下并不会直接报错，而是会进入死循环。</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="在超算上使用-spack">在超算上使用 Spack<a class="hash-link" href="#在超算上使用-spack" title="Direct link to heading">​</a></h2><p>当用户在超算上做开发时，可能需要安装有较多依赖的软件。手动管理这些依赖是非常麻烦的，此时我们可以在超算上配置 Spack，这不仅可以让我们快速批量安装软件，同时能利用实验室集群上已有的配置文件、软件包源码达到节省时间的目的。</p><p>Spack 安装的软件默认使用 RPATH（可关闭），实验室集群上的公共软件包不能直接拷贝到超算，需要重新编译。如果要交叉编译后直接拷贝到超算，注意取消 RPATH。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="基本配置">基本配置<a class="hash-link" href="#基本配置" title="Direct link to heading">​</a></h3><p>我们使用的超算可能没有办法联网下载文件。为了在超算上用 Spack 安装软件包，需要我们事先准备以下数据：</p><ul><li>Spack 的 git 仓库，从官网下载或直接从实验室集群上拷贝均可；</li><li>实验室集群的 Spack mirror，位于 <code>/apps/sources/spack</code>；</li><li>实验室集群的 Spack repo，位于 <code>/apps/repos/spack</code>。</li></ul><p>拷贝数据到超算后，参考实验室集群文档中关于 Spack 的说明、公共 Spack 的配置（<code>config.yaml</code>、<code>packages.yaml</code> 等配置文件）来配置用户级 Spack，然后使用 Spack 安装软件即可。如果需要安装的软件在集群的 Spack mirror 中没有源代码，用户可以自行下载。</p><p>实验室集群的公共 Spack 配置文件可以在加载公共 Spack 环境后用命令查看：</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 打印config.yaml文件中的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config --scope site get config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看config.yaml文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ spack config --scope site edit config</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Spack repos</h5></div><div class="admonition-content"><p>实验室集群上可能有多个自定义 packages 的 Spack repos，它们属于不同的名字空间。其中，有一部分在 GitHub 上维护，其余仅在实验室集群上可见。</p><p><code>namespace hpcde</code>：<a href="https://github.com/hpcde/spack-repos" target="_blank" rel="noopener noreferrer">https://github.com/hpcde/spack-repos</a></p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="externals-1"><code>externals</code><a class="hash-link" href="#externals-1" title="Direct link to heading">​</a></h3><p>超算上有一些软件是我们很难自己安装的，比如编译器、MPI 等。它们通常都有特定的 flags 或者运行时环境变量。因此，我们要把超算上已有的开发工具都指定为外部软件包，让 Spack 根据它们安装其他软件。按照外部软件包的设置方法，超算上的已有软件也分为两种：</p><ul><li>系统自带的，比如 <code>/usr</code> 路径下的 <code>ld</code>、<code>ar</code> 等工具（属于 <code>binutils</code>），它们可能是超算默认的 <code>binutils</code>。这种情况下我们只能在 <code>packages.yaml</code> 文件中用 <code>prefix</code> 来指定路径；</li><li>以模块加载的，比如 <code>gcc/8.3.0</code>，这类软件是由超算管理员安装，且可能设置了特定的 flags。此时我们可以在 <code>packages.yaml</code> 文件中用 <code>modules</code> 来指定外部软件包位置，同时要注意在 <code>compilers.yaml</code> 中设置相应的 <code>cflags</code>、<code>cxxflags</code>、<code>fflags</code> 等参数。</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="模块文件生成">模块文件生成<a class="hash-link" href="#模块文件生成" title="Direct link to heading">​</a></h3><p>在实验室集群上我们可以仅使用 Spack，但在超算上不同，我们无法完全避免使用 <code>module</code> 命令来加载已有软件。混用 <code>spack load</code> 和 <code>module load</code> 可能会引发不易察觉的问题，因此我们可以事先让 Spack 为它安装的软件生成模块文件，随后仅使用 <code>module</code> 来加载所需的软件包。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/hpcde/cluster-docs/blob/master/docs/users/software/01-spack.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-05-14T06:09:24.000Z">5/14/2021</time></b> by <b>one</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cluster-docs/docs/users/login/proxy-login"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">外网代理登录</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cluster-docs/docs/users/software/lmod"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lmod - 使用集群上的软件</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#快速入门" class="table-of-contents__link toc-highlight">快速入门</a><ul><li><a href="#rosetta-stone从-module-到-spack" class="table-of-contents__link toc-highlight">Rosetta Stone：从 <code>module</code> 到 <code>spack</code></a></li></ul></li><li><a href="#基本概念" class="table-of-contents__link toc-highlight">基本概念</a><ul><li><a href="#公共-spack" class="table-of-contents__link toc-highlight">公共 Spack</a></li><li><a href="#用户级-spack" class="table-of-contents__link toc-highlight">用户级 Spack</a></li><li><a href="#spec" class="table-of-contents__link toc-highlight">spec</a></li><li><a href="#add-concretize-install" class="table-of-contents__link toc-highlight">add, concretize, install</a></li><li><a href="#environment" class="table-of-contents__link toc-highlight">environment</a></li><li><a href="#view" class="table-of-contents__link toc-highlight">view</a></li></ul></li><li><a href="#查询软件包" class="table-of-contents__link toc-highlight">查询软件包</a><ul><li><a href="#spack-find" class="table-of-contents__link toc-highlight"><code>spack find</code></a></li><li><a href="#spack-info" class="table-of-contents__link toc-highlight"><code>spack info</code></a></li></ul></li><li><a href="#加载卸载软件包" class="table-of-contents__link toc-highlight">加载/卸载软件包</a></li><li><a href="#加载-python-包" class="table-of-contents__link toc-highlight">加载 Python 包</a></li><li><a href="#使用文件系统视图" class="table-of-contents__link toc-highlight">使用文件系统视图</a></li><li><a href="#使用虚拟环境" class="table-of-contents__link toc-highlight">使用虚拟环境</a></li><li><a href="#配置用户级-spack" class="table-of-contents__link toc-highlight">配置用户级 Spack</a><ul><li><a href="#安装-spack" class="table-of-contents__link toc-highlight">安装 Spack</a></li><li><a href="#连接到公共-spack" class="table-of-contents__link toc-highlight">连接到公共 Spack</a></li><li><a href="#修改其他配置文件" class="table-of-contents__link toc-highlight">修改其他配置文件</a></li></ul></li><li><a href="#安装删除软件包" class="table-of-contents__link toc-highlight">安装/删除软件包</a><ul><li><a href="#工作流" class="table-of-contents__link toc-highlight">工作流</a></li><li><a href="#清理依赖项" class="table-of-contents__link toc-highlight">清理依赖项</a></li><li><a href="#仅安装依赖" class="table-of-contents__link toc-highlight">仅安装依赖</a></li></ul></li><li><a href="#让spack使用外部软件包" class="table-of-contents__link toc-highlight">让Spack使用外部软件包</a><ul><li><a href="#externals" class="table-of-contents__link toc-highlight"><code>externals</code></a></li><li><a href="#搜索外部软件包" class="table-of-contents__link toc-highlight">搜索外部软件包</a></li><li><a href="#外部软件包的依赖" class="table-of-contents__link toc-highlight">外部软件包的依赖</a></li><li><a href="#可供参考的配置" class="table-of-contents__link toc-highlight">可供参考的配置</a></li></ul></li><li><a href="#模块文件" class="table-of-contents__link toc-highlight">模块文件</a><ul><li><a href="#生成-modulefiles" class="table-of-contents__link toc-highlight">生成 modulefiles</a></li><li><a href="#加载模块" class="table-of-contents__link toc-highlight">加载模块</a></li><li><a href="#modulesyaml" class="table-of-contents__link toc-highlight"><code>modules.yaml</code></a></li></ul></li><li><a href="#自定义软件包" class="table-of-contents__link toc-highlight">自定义软件包</a></li><li><a href="#在超算上使用-spack" class="table-of-contents__link toc-highlight">在超算上使用 Spack</a><ul><li><a href="#基本配置" class="table-of-contents__link toc-highlight">基本配置</a></li><li><a href="#externals-1" class="table-of-contents__link toc-highlight"><code>externals</code></a></li><li><a href="#模块文件生成" class="table-of-contents__link toc-highlight">模块文件生成</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cluster-docs/docs/users/getting-started">User Manual</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://git.hpcer.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">HPCer Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://hub.hpcer.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">HPCer Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="http://status.hpc.hpcer.dev/zabbix/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cluster Status<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cluster-docs/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/hpcde/cluster-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Doc Source on Git<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://hpcde.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">HPCDE lab<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/cluster-docs/help">Help</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://hpcde.github.io/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_gHmE"><img src="/cluster-docs/img/oss_logo.svg" alt="HPCer cluster" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/cluster-docs/img/oss_logo.svg" alt="HPCer cluster" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright © 2022 HPCDE lab. Built with Docusaurus.</div></div></div></footer></div>
<script src="/cluster-docs/assets/js/runtime~main.540aceb6.js"></script>
<script src="/cluster-docs/assets/js/main.45e5c709.js"></script>
</body>
</html>